
<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8" />
        <title>Socket简单聊天室 | Qheの小窝</title>
        <meta name="author" content="Qhe" />
        <meta name="description" content="" />
        <meta name="keywords" content="" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
        <link rel="icon" href="/images/zhenxun.jpg" />
        <script src="https://cdn.staticfile.org/vue/3.2.47/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.3.0/css/all.min.css" />
<link rel="stylesheet" href="/css/fonts.min.css" />
<script> const mixins = {}; </script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>


<script src="https://cdn.staticfile.org/highlight.js/11.7.0/highlight.min.js"></script>
<link
    rel="stylesheet"
    href="https://cdn.staticfile.org/highlight.js/11.7.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

    <meta name="generator" content="Hexo 6.3.0"></head>
    <body>
<div id="cursor"></div>
<link rel="stylesheet" href="/css/cursor.min.css" />
<script src="/js/cursor.min.js"></script>
<canvas
    id="background"
    style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: -1"
></canvas>
<script src="/js/background.min.js"></script>
<canvas
    id="fireworks"
    style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 32767"
></canvas>
<script src="https://cdn.staticfile.org/animejs/3.2.1/anime.min.js"></script>
<script src="/js/fireworks.min.js"></script>
        <div id="layout">
            <transition name="fade">
                <div id="loading" v-show="loading">
                    <div id="loading-circle">
                        <h2>LOADING</h2>
                        <p>加载过慢请开启缓存 浏览器默认开启</p>
                        <img src="/images/loading.gif" />
                    </div>
                </div>
            </transition>
            <nav id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <div id="desktop-menu">
        <a class="title" href="/">
            <span>QHEの小窝</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;QHEの小窝</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </div>
</nav>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

            <transition name="into">
                <div id="main" v-show="!loading">
                    <div class="article">
    <div>
        <h1>Socket简单聊天室</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/5/5
        </span>
        
        <span class="category">
            <a href="/categories/Java/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                Java
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            <span class="tag">
                
                <a href="/tags/Java/" style="color: #00a596">Java</a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/Socket/" style="color: #00a596">Socket</a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" style="color: #03a9f4">网络编程</a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><strong>所用知识</strong>: GUI、Socket、多线程、单例模式.  </p>
<p><strong>交互模式</strong>: C&#x2F;S模式  </p>
<p><strong>辅助工具</strong>: WindowBuilder(可视化快速搭建GUI界面)  </p>
<p><strong>环境</strong>: eclipse、Java8</p>
<span id="more"></span>

<p><strong>文件结构</strong>:  </p>
<ul>
<li><p>Client:</p>
<ul>
<li>ClientFrame.java		#聊天室图形界面  </li>
<li>ClientGM.java			#单例模式，用于连接线程和GUI图形界面控件  </li>
<li>ClientSocket.java 	#与服务器连接的Socket线程</li>
</ul>
</li>
<li><p>Server:</p>
<ul>
<li>ServerFrame.java		#服务器图形界面  </li>
<li>ServerListener.java 	#服务器监听，用于检测客户端连接  </li>
<li>ServerMG.java			#单例模式，用于连接线程和GUI图形界面  </li>
<li>ServerThread.java		#服务端Socket线程，与客户端Socket线程相连</li>
</ul>
</li>
</ul>
<h2 id="PS-文件传输功能还没来得及加上，等有时间再做处理。"><a href="#PS-文件传输功能还没来得及加上，等有时间再做处理。" class="headerlink" title="PS:文件传输功能还没来得及加上，等有时间再做处理。"></a><strong>PS</strong>:文件传输功能还没来得及加上，等有时间再做处理。</h2><h3 id="实现界面"><a href="#实现界面" class="headerlink" title="实现界面"></a>实现界面</h3><p>服务端界面:<br><img src="/images/Socket_2023.05.05/ServerFrame.jpg"></p>
<p>客户端界面:<br><img src="/images/Socket_2023.05.05/login.jpg"></p>
<p>私聊:<br><img src="/images/Socket_2023.05.05/privateChat.jpg"></p>
<p>群聊:<br><img src="/images/Socket_2023.05.05/groupChat.jpg"></p>
<h3 id="流程说明"><a href="#流程说明" class="headerlink" title="流程说明"></a>流程说明</h3><h4 id="一、用户登录"><a href="#一、用户登录" class="headerlink" title="一、用户登录"></a>一、用户登录</h4><pre><code>客户端：
    1、发送登录信息，格式：LOGIN|Username   
    2、处理所有在线用户的用户信息，格式：USERLISTS|user1_user2_user3_ ....  
    3、处理新上线用户信息,更新在线用户列表，格式：ADD|username   

服务器端：
    1、处理用户登录请求，得到所有在线用户信息名称，发回给请求的客户端， 格式：USERLISTS|user1_user2_user3_ ....    
    2、将当前登录用户的Socket信息（Socket所在的线程对象）放入Arraylist中。  
    3、将当前登录用户的信息（如：用户名），发送给已经在线的其他用户， 格式：ADD|userName  
</code></pre>
<h4 id="二、私聊"><a href="#二、私聊" class="headerlink" title="二、私聊"></a>二、私聊</h4><pre><code>客户端：
    1、选择私聊用户（列表框选择）
    2、将私聊信息发送到服务器中转，格式：MSG|SenderName|RecName|MSGInfo　　　
    3、接收服务器中转发回的聊天信息，格式：MSG|SenderName|MSGInfo　
服务器端：
    1、通过RecName用户名查目标Socket信息，　　
    2、向目标Socket对象发送中转的聊天信息，格式：MSG|SenderName|MSGInfo　　
</code></pre>
<h4 id="三、群聊"><a href="#三、群聊" class="headerlink" title="三、群聊"></a>三、群聊</h4><pre><code>客户端：
    1、将群聊信息发送到服务器中转，格式：MSG｜Sendername|ALL|MSGInfo　　　
    2、接收服务器中转发回的群聊信息，格式：MSG|SenderName|MSGInfo　
服务器端：
    1、遍历所有在线用户的Socket对象，发送中转的群聊信息，格式：MSG|SenderName|MSGInfo　	
</code></pre>
<h4 id="四、用户退出连接"><a href="#四、用户退出连接" class="headerlink" title="四、用户退出连接"></a>四、用户退出连接</h4><pre><code>客户端：
    1、向服务器发送下线消息，格式：OFFLINE|username
    2、关闭Socket，清空在线用户列表
    3、处理下线用户信息，删除用户列表中的用户名，格式：DEL|username		

服务器端：
    1、处理客户端的下线请求，格式：OFFLINE|username
    2、向所有的其他在线用户发送用户下线消息，格式：DEL|username
    3、清除ArrayList中的当前用户信息
</code></pre>
<h4 id="五、服务器关闭"><a href="#五、服务器关闭" class="headerlink" title="五、服务器关闭"></a>五、服务器关闭</h4><pre><code>　　客户端：
    1、处理服务器闭关信息，界面显示服务器关闭。 格式： CLOSE
    2、关闭当前Socket连接，
    3、清空在线用户列表

服务器端：
    1、向所有在线用户发送关闭服务器的信息，格式：CLOSE
    2、遍历所有在线用户的Socket对象，并逐一关闭
    3、清空存储在线用户信息的ArrayList
    4、关闭SokcetListener
    5、关闭ServerSocket
</code></pre>
<h4 id="六、文件传输"><a href="#六、文件传输" class="headerlink" title="六、文件传输"></a>六、文件传输</h4><pre><code>客户端：
    1、选择待传输的文件，File类获取文件的相关信息（文件名、文件长度）
    2、创建临时的文件传输用服务器（serverSocket）,新开一个线程。
    3、发送文件相关信息和文件服务器相关信息到聊天服务器，格式：FILETRANS|sendername|recName|文件名|文件长度|IP|Port
    4、处理服务器转发的FILETRANS命令，显示文件信息，询问接收用户是否接收文件？JOptoinPane-&gt;confirm
    5、同意接收时，根据IP和Port连接到文件传输服务器，新开线程进行文件传输操作
    6、拒绝接收时，向聊天服务器发送拒绝接收文件消息，格式：FILECANCEL|sendername|recname
    7、处理FILECANCEL，关闭文件传输用的serversocket
服务器端：
    1、处理FILETRANS命令，根据RecName查找SocketChat对象，
    2、转发文件传输的相关信息，格式：FILETRANS|sendername|文件名|文件长度|IP|Port          
    3、处理客户端拒绝接收文件的命令，格式：FILECANCEL|sendername|recname，
    4、查找文件传输发起者的Socket信息,发送文件取消发送的信息，格式：FILECANCEL
</code></pre>
<h3 id="代码部分"><a href="#代码部分" class="headerlink" title="代码部分"></a>代码部分</h3><h4 id="ClientFrame-java"><a href="#ClientFrame-java" class="headerlink" title="ClientFrame.java"></a>ClientFrame.java</h4><pre><code class="Java">package Client;
import java.awt.BorderLayout;
import java.awt.EventQueue;

import javax.swing.JFrame;
import javax.swing.JPanel;
import javax.swing.border.EmptyBorder;
import javax.swing.border.TitledBorder;
import javax.swing.JLabel;
import javax.swing.JTextField;
import javax.swing.ListModel;
import javax.swing.UIManager;
import javax.swing.UnsupportedLookAndFeelException;
import javax.swing.JButton;
import javax.swing.JScrollPane;
import java.awt.event.ActionListener;
import java.text.SimpleDateFormat;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Date;
import java.awt.event.ActionEvent;
import java.awt.Color;
import java.awt.Component;
import java.awt.Container;

import javax.swing.JTextArea;
import javax.swing.DefaultListModel;
import javax.swing.DropMode;
import javax.swing.JList;
import javax.swing.JOptionPane;

import java.awt.Font;
import javax.swing.JTabbedPane;

public class ClientFrame extends JFrame &#123;

    private JPanel contentPane;
    public JPanel panel;
    public JLabel lblNewLabel;
    public JTextField IPAdress;
    public JLabel label;
    public JTextField Port;
    public JLabel label_1;
    public JTextField UserName;
    public JButton Login;
    public JButton Quit;
    public JPanel panel_1;
    public JPanel panel_2;
    public JPanel panel_3;
    public JScrollPane scrollPane;
    public JScrollPane scrollPane_1;
    public JButton Send;
    public JTextArea ChatBox;
    public JList UserList;
    public DefaultListModel userList;
    public JButton Send_1;
    public JTabbedPane tabbedPane;
    public JTextArea Message;
    /**
     * Launch the application.
     */
    public static void main(String[] args) &#123;
        try &#123;
            String lookAndFeel = UIManager.getSystemLookAndFeelClassName();
            UIManager.setLookAndFeel(lookAndFeel);
        &#125; catch (Exception e) &#123;
            // TODO Auto-generated catch block
            e.printStackTrace();
        &#125;
        EventQueue.invokeLater(new Runnable() &#123;
            public void run() &#123;
                try &#123;
                    ClientFrame frame = new ClientFrame();
                    frame.setVisible(true);
                    ClientMG.getClientMG().setFrame(frame);
                &#125; catch (Exception e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;
        &#125;);
    &#125;

    /**
     * Create the frame.
     */
    public ClientFrame() &#123;
        setTitle(&quot;\u804A\u5929\u5BA2\u6237\u7AEF&quot;);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setBounds(100, 100, 544, 573);
        contentPane = new JPanel();
        contentPane.setBorder(new EmptyBorder(5, 5, 5, 5));
        setContentPane(contentPane);
        contentPane.setLayout(null);
        
        panel = new JPanel();
        panel.setBorder(new TitledBorder(null, &quot;\u914D\u7F6E&quot;, TitledBorder.LEADING, TitledBorder.TOP, null, null));
        panel.setBounds(0, 10, 526, 45);
        contentPane.add(panel);
        panel.setLayout(null);
        
        lblNewLabel = new JLabel(&quot;\u4E3B\u673AIP&quot;);
        lblNewLabel.setBounds(22, 12, 54, 25);
        panel.add(lblNewLabel);
        
        IPAdress = new JTextField();
        IPAdress.setBounds(64, 14, 100, 21);
        panel.add(IPAdress);
        IPAdress.setColumns(10);
        
        label = new JLabel(&quot;\u7AEF\u53E3&quot;);
        label.setBounds(174, 12, 36, 25);
        panel.add(label);
        
        Port = new JTextField();
        Port.setColumns(10);
        Port.setBounds(205, 14, 44, 21);
        panel.add(Port);
        
        label_1 = new JLabel(&quot;\u7528\u6237\u540D&quot;);
        label_1.setBounds(258, 12, 44, 25);
        panel.add(label_1);
        
        UserName = new JTextField();
        UserName.setColumns(10);
        UserName.setBounds(299, 14, 75, 21);
        panel.add(UserName);
        
        Login = new JButton(&quot;\u767B\u9646&quot;);
        this.Login.addActionListener(new LoginActionListener());
        Login.setBounds(385, 13, 63, 23);
        panel.add(Login);
        
        Quit = new JButton(&quot;\u9000\u51FA&quot;);
        this.Quit.addActionListener(new QuitActionListener());
        Quit.setBounds(453, 13, 63, 23);
        panel.add(Quit);
        
        panel_1 = new JPanel();
        panel_1.setBorder(new TitledBorder(null, &quot;\u804A\u5929\u8BB0\u5F55&quot;, TitledBorder.LEADING, TitledBorder.TOP, null, null));
        panel_1.setBounds(0, 65, 341, 349);
        contentPane.add(panel_1);
        panel_1.setLayout(null);
        
        scrollPane = new JScrollPane();
        scrollPane.setBounds(10, 21, 321, 318);
        panel_1.add(scrollPane);
        
        this.ChatBox = new JTextArea();
        this.ChatBox.setLineWrap(true);
        this.ChatBox.setEditable(false);
        this.scrollPane.setViewportView(this.ChatBox);
        
        panel_2 = new JPanel();
        panel_2.setBorder(new TitledBorder(null, &quot;\u5728\u7EBF\u7528\u6237&quot;, TitledBorder.LEADING, TitledBorder.TOP, null, null));
        panel_2.setBounds(341, 65, 185, 349);
        contentPane.add(panel_2);
        panel_2.setLayout(null);
        
        scrollPane_1 = new JScrollPane();
        scrollPane_1.setBounds(10, 22, 165, 317);
        panel_2.add(scrollPane_1);
        
        userList = new DefaultListModel();
        this.UserList = new JList(userList);
        this.UserList.setFont(new Font(&quot;����&quot;, Font.PLAIN, 16));
        this.scrollPane_1.setViewportView(this.UserList);
        
        panel_3 = new JPanel();
        panel_3.setBorder(new TitledBorder(null, &quot;\u53D1\u9001&quot;, TitledBorder.LEADING, TitledBorder.TOP, null, null));
        panel_3.setBounds(0, 413, 526, 113);
        contentPane.add(panel_3);
        panel_3.setLayout(null);
        
        Send = new JButton(&quot;单发&quot;);
        this.Send.addActionListener(new SendActionListener());
        Send.setBounds(444, 80, 72, 23);
        panel_3.add(Send);
        
        this.Send_1 = new JButton(&quot;群发&quot;);
        this.Send_1.addActionListener(new Send_1ActionListener());
        this.Send_1.setBounds(347, 80, 72, 23);
        this.panel_3.add(this.Send_1);
        
        this.tabbedPane = new JTabbedPane(JTabbedPane.TOP);
        this.tabbedPane.setBounds(135, 70, 5, 5);
        this.panel_3.add(this.tabbedPane);
        
        this.Message = new JTextArea();
        this.Message.setBounds(10, 22, 506, 48);
        this.panel_3.add(this.Message);
    &#125;
    
    private class LoginActionListener implements ActionListener &#123;
        public void actionPerformed(ActionEvent arg0) &#123;
            //登录
            String IP;
            int PORT;
            String userName;
            try &#123;
                IP = IPAdress.getText();
                PORT = Integer.parseInt(Port.getText());
                userName = UserName.getText().trim();
                if(userName.equals(&quot;&quot;)) &#123;
                    ClientMG.getClientMG().setLog(&quot;用户名不可为空&quot;);
                    return;
                &#125;
                //采用新线程，防止尝试连接服务器时，客户端界面线程等待
                new Thread() &#123;
                    public void run() &#123;
                        if(ClientMG.getClientMG().login(IP, PORT, userName)) &#123;
                            ClientMG.getClientMG().setLog(&quot;登陆成功&quot;);
                            Login.setEnabled(false);
                        &#125;else &#123;
                            ClientMG.getClientMG().setLog(&quot;登陆失败&quot;);
                        &#125;
                    &#125;
                &#125;.start();
            &#125; catch (Exception e) &#123;
                // TODO Auto-generated catch block
                ClientMG.getClientMG().setLog(&quot;请填写正确的信息&quot;);
            &#125;
        &#125;
    &#125;
    private class SendActionListener implements ActionListener &#123;
        public void actionPerformed(ActionEvent arg0) &#123;
            //发消息前提:登录
            if(ClientMG.getClientMG().getSocket() == null) &#123;
                return;
            &#125;
            //单发
            String message = Message.getText();
            String senderName = ClientMG.getClientMG().getSocket().getName();
            String recName = (String) UserList.getSelectedValue();
            if(message.equals(&quot;&quot;)) &#123;
                return;
            &#125;
            ClientMG.getClientMG().sendMSG(&quot;MSG|&quot; + senderName + &quot;|&quot; + recName + &quot;|&quot; +message);
            
            //获取时间(本地显示)
            LocalDateTime localDateTime = LocalDateTime.now();
            String date = localDateTime.format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;));					
            ClientMG.getClientMG().getFrame().ChatBox.append(&quot;[我]&quot; + &quot; &quot; +date + &quot;\n&quot;);
            ClientMG.getClientMG().getFrame().ChatBox.append(message + &quot;\n&quot;);
            Message.setText(&quot;&quot;);
        &#125;
    &#125;
    private class Send_1ActionListener implements ActionListener &#123;
        public void actionPerformed(ActionEvent e) &#123;
            //发消息前提:登录
            if(ClientMG.getClientMG().getSocket() == null) &#123;
                return;
            &#125;
            //群发
            String message = Message.getText();
            String senderName = ClientMG.getClientMG().getSocket().getName();
            if(message.equals(&quot;&quot;)) &#123;
                return;
            &#125;
            ClientMG.getClientMG().sendMSG(&quot;MSG|&quot; + senderName + &quot;|ALL|&quot; +message);
            Message.setText(&quot;&quot;);
        &#125;
    &#125;
    private class QuitActionListener implements ActionListener &#123;
        public void actionPerformed(ActionEvent e) &#123;
            //退出
            ClientMG.getClientMG().closeSocket();
            Login.setEnabled(true);
        &#125;
    &#125;
&#125;
</code></pre>
<h4 id="ClientMG-java"><a href="#ClientMG-java" class="headerlink" title="ClientMG.java"></a>ClientMG.java</h4><pre><code class="Java">package Client;

import java.io.IOException;
import java.net.*;

import javax.swing.JOptionPane;

public class ClientMG &#123;
    private static final ClientMG clientmg = new ClientMG();
    private ClientFrame clientFrame;
    private ClientSocket cs = null;
    private ClientMG() &#123;&#125;
    
    //获取MG
    public static ClientMG getClientMG() &#123;
        return clientmg;
    &#125;
    
    //建立Frame
    public void setFrame(ClientFrame frame) &#123;
        clientFrame = frame;
    &#125;
    
    //得到Frame
    public ClientFrame getFrame() &#123;
        return clientFrame;
    &#125;
    
    //获取当前客户端线程
    public ClientSocket getSocket() &#123;
        return cs;
    &#125;
    
    //添加用户列表
    public void addUsers(String[] users) &#123;
        for(String user:users) &#123;
            clientFrame.userList.addElement(user);
        &#125;
    &#125;
    
    //更新用户列表
    public void addUser(String user) &#123;
        clientFrame.userList.addElement(user);
    &#125;
    
    //登录
    public boolean login(String IP,int PORT,String userName) &#123;
        Socket socket = null;
        try &#123;
            socket = new Socket(IP,PORT);
            cs = new ClientSocket(socket,userName);				
            cs.start();
            return true;
        &#125; catch (IOException e) &#123;
            // TODO Auto-generated catch block
            return false;	
        &#125;
    &#125;
    
    //聊天
    public void sendMSG(String str) &#123;
        if(cs != null) &#123;
            cs.send(str);
        &#125;
    &#125;
    
    //退出
    public void closeSocket() &#123;
        if(cs == null) &#123;
            return;		//未登录 
        &#125;
        cs.send(&quot;OFFLINE|&quot; + cs.getName());
        cs = null;
        ClientMG.getClientMG().getFrame().userList.clear();
        setLog(&quot;退出成功&quot;);
    &#125;
    
    //聊天框内容
    public void setLog(String str) &#123;
        clientFrame.ChatBox.append(str + &quot;\n&quot;);
    &#125;
&#125;

</code></pre>
<h4 id="ClientSocket-java"><a href="#ClientSocket-java" class="headerlink" title="ClientSocket.java"></a>ClientSocket.java</h4><pre><code class="Java">package Client;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.io.PrintWriter;
import java.net.Socket;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Date;

public class ClientSocket extends Thread&#123;
    Socket socket = null;
    PrintWriter pw = null;
    BufferedReader br = null;
    ClientSocket(Socket socket,String user)&#123;
        super(user);
        this.socket = socket;
    &#125;
    
    public void run() &#123;
        
        try &#123;
            pw = new PrintWriter(new OutputStreamWriter(socket.getOutputStream(),&quot;utf-8&quot;));
            br = new BufferedReader(new InputStreamReader(socket.getInputStream(),&quot;utf-8&quot;));
            String Request;
            String Response;
            
            //发送登录信息
            Request = &quot;LOGIN|&quot; + ClientMG.getClientMG().getFrame().UserName.getText().trim();
            send(Request);
            LocalDateTime localDateTime = null;
            while((Response = br.readLine()) != null) &#123;
                String[] strs = Response.split(&quot;\\|&quot;);
                //获取用户列表
                if(strs[0].equals(&quot;USERLIST&quot;)) &#123;
                    if(strs.length &gt; 1) &#123;
                        String[] users = strs[1].split(&quot;_&quot;);
                        ClientMG.getClientMG().addUsers(users);
                    &#125;
                &#125;else if(strs[0].equals(&quot;ADD&quot;)) &#123;
                    //当新用户登陆时，更新用户列表
                    ClientMG.getClientMG().addUser(strs[1]);
                &#125;else if(strs[0].equals(&quot;MSG&quot;)) &#123;
                    //获取聊天消息
                    localDateTime = LocalDateTime.now();	//获取时间
                    String date = localDateTime.format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;));					
                    ClientMG.getClientMG().getFrame().ChatBox.append(strs[1] + &quot; &quot; +date + &quot;\n&quot;);
                    ClientMG.getClientMG().getFrame().ChatBox.append(strs[2] + &quot;\n&quot;);
                &#125;else if(strs[0].equals(&quot;DEL&quot;)) &#123;
                    //其他用户下线
                    ClientMG.getClientMG().getFrame().userList.removeElement(strs[1]);
                &#125;else if(strs[0].equals(&quot;CLOSE&quot;)) &#123;
                    //服务器关闭，所有用户下线
                    ClientMG.getClientMG().getFrame().userList.clear();
                    ClientMG.getClientMG().setLog(&quot;[Server]服务器已关闭&quot;);
                    break;
                &#125;
            &#125;
        &#125; catch (IOException e) &#123;
            // TODO Auto-generated catch block
        &#125;finally &#123;
            ClientMG.getClientMG().closeSocket();
            try &#123;
                if(pw != null) &#123;
                    pw.close();
                &#125;
                if(br != null) &#123;
                    br.close();
                &#125;
                if(socket != null) &#123;
                    socket.close();
                &#125;
            &#125;catch(Exception e)&#123;
                e.printStackTrace();
            &#125;
        &#125;
    &#125;
    
    //向服务端发送消息
    public void send(String str) &#123;
        pw.println(str);
        pw.flush();
    &#125;
&#125;
</code></pre>
<h4 id="ServerFrame-java"><a href="#ServerFrame-java" class="headerlink" title="ServerFrame.java"></a>ServerFrame.java</h4><pre><code class="Java">package Server;

import java.awt.BorderLayout;
import java.awt.EventQueue;

import javax.swing.JFrame;
import javax.swing.JPanel;
import javax.swing.border.EmptyBorder;
import javax.swing.border.TitledBorder;
import javax.swing.JLabel;
import javax.swing.JTextField;
import javax.swing.UIManager;
import javax.swing.JButton;
import javax.swing.JScrollPane;
import javax.swing.JTextArea;
import java.awt.event.ActionListener;
import java.io.*;
import java.net.*;
import java.util.HashMap;
import java.awt.event.ActionEvent;

public class ServerFrame extends JFrame &#123;

    private JPanel contentPane;
    public JPanel panel;
    public JLabel lblNewLabel;
    public JTextField PORTField;
    public JButton Start;
    public JButton Close;
    public JPanel panel_1;
    public JScrollPane scrollPane;
    public JTextArea textArea;

    /**
     * Launch the application.
     */
    public static void main(String[] args) &#123;
        try &#123;
            String lookAndFeel =UIManager.getSystemLookAndFeelClassName();
            UIManager.setLookAndFeel(lookAndFeel);
        &#125; catch (Exception e) &#123;
            // TODO Auto-generated catch block
            e.printStackTrace();
        &#125;
        EventQueue.invokeLater(new Runnable() &#123;
            public void run() &#123;
                try &#123;
                    ServerFrame frame = new ServerFrame();
                    frame.setVisible(true);
                    ServerMG.getServerMG().setFrame(frame);
                &#125; catch (Exception e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;
        &#125;);
    &#125;

    /**
     * Create the frame.
     */
    public ServerFrame() &#123;
        setTitle(&quot;服务端&quot;);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setBounds(100, 100, 376, 493);
        this.contentPane = new JPanel();
        this.contentPane.setBorder(new EmptyBorder(5, 5, 5, 5));
        setContentPane(this.contentPane);
        this.contentPane.setLayout(null);
        
        this.panel = new JPanel();
        this.panel.setBorder(new TitledBorder(null, &quot;\u914D\u7F6E\u4FE1\u606F&quot;, TitledBorder.LEADING, TitledBorder.TOP, null, null));
        this.panel.setBounds(10, 10, 340, 53);
        this.contentPane.add(this.panel);
        this.panel.setLayout(null);
        
        this.lblNewLabel = new JLabel(&quot;端口&quot;);
        this.lblNewLabel.setBounds(10, 21, 54, 22);
        this.panel.add(this.lblNewLabel);
        
        this.PORTField = new JTextField();
        this.PORTField.setBounds(42, 22, 66, 21);
        this.panel.add(this.PORTField);
        this.PORTField.setColumns(10);
        
        this.Start = new JButton(&quot;开启&quot;);
        this.Start.addActionListener(new StartActionListener());
        this.Start.setBounds(128, 21, 93, 23);
        this.panel.add(this.Start);
        
        this.Close = new JButton(&quot;关闭&quot;);
        this.Close.addActionListener(new CloseActionListener());
        this.Close.setBounds(231, 21, 93, 23);
        this.panel.add(this.Close);
        
        this.panel_1 = new JPanel();
        this.panel_1.setBorder(new TitledBorder(null, &quot;\u6D88\u606F\u8BB0\u5F55&quot;, TitledBorder.LEADING, TitledBorder.TOP, null, null));
        this.panel_1.setBounds(10, 73, 340, 372);
        this.contentPane.add(this.panel_1);
        this.panel_1.setLayout(null);
        
        this.scrollPane = new JScrollPane();
        this.scrollPane.setBounds(10, 21, 320, 341);
        this.panel_1.add(this.scrollPane);
        
        this.textArea = new JTextArea();
        this.textArea.setEditable(false);
        this.scrollPane.setViewportView(this.textArea);
    &#125;
    
    
    private class StartActionListener implements ActionListener &#123;
        public void actionPerformed(ActionEvent arg0) &#123;
            try &#123;
                //开启服务器
                int PORT = Integer.parseInt(PORTField.getText().trim());
                if(ServerMG.getServerMG().startServer(PORT)) &#123;
                    ServerMG.getServerMG().setLog(&quot;[INFO]服务器已开启&quot;);
                    Start.setEnabled(false);
                &#125;else &#123;
                    ServerMG.getServerMG().setLog(&quot;[INFO]服务器开启失败&quot;);
                &#125;
            &#125; catch (Exception e) &#123;
                // TODO Auto-generated catch block
                ServerMG.getServerMG().setLog(&quot;[ERROR]端口非法&quot;);
            &#125;
        &#125;
    &#125;
    private class CloseActionListener implements ActionListener &#123;
        public void actionPerformed(ActionEvent e) &#123;
            //关闭服务器
            ServerMG.getServerMG().closeServer();
            Start.setEnabled(true);
        &#125;
    &#125;
    
&#125;
</code></pre>
<h4 id="ServerListener-java"><a href="#ServerListener-java" class="headerlink" title="ServerListener.java"></a>ServerListener.java</h4><pre><code class="Java">package Server;
import java.io.*;
import java.net.*;

public class ServerListener extends Thread&#123;
    ServerSocket server;
    ServerListener(ServerSocket server)&#123;
        this.server = server;
    &#125;
    public void run() &#123;
        try &#123;
            while(true) &#123;
                Socket socket = server.accept();
                SocketThread st = new SocketThread(socket);
                st.start();
                ServerMG.getServerMG().setLog(&quot;[INFO]&quot;+socket+&quot;已登录&quot;);
            &#125; 
        &#125; catch (Exception e) &#123;
            //强制关闭server而是该线程关闭
        &#125; finally &#123;
            try &#123;
                if(server != null) &#123;
                    server.close();
                    server = null;
                &#125;
            &#125;catch(Exception e) &#123;
                e.printStackTrace();
            &#125;
            
        &#125;
    &#125;
&#125;
</code></pre>
<h4 id="ServerMG-java"><a href="#ServerMG-java" class="headerlink" title="ServerMG.java"></a>ServerMG.java</h4><pre><code class="Java">package Server;

import java.io.*;
import java.net.*;
import java.util.ArrayList;

public class ServerMG &#123;
    private static final ServerMG servermg = new ServerMG();
    private ServerFrame serverFrame;
    private ServerSocket server = null;
    private ArrayList&lt;SocketThread&gt; userList = new ArrayList();
    private ServerMG() &#123;&#125;
    //获取MG
    public static ServerMG getServerMG() &#123;
        return servermg;
    &#125;
    //获取Frame
    public void setFrame(ServerFrame frame) &#123;
        serverFrame = frame;
    &#125;
    public ServerFrame getFrame() &#123;
        return serverFrame;
    &#125;
    //开启服务器
    public boolean startServer(int PORT) &#123;
            try &#123;
                server = new ServerSocket(PORT);
                new ServerListener(server).start();
                setLog(&quot;[INFO]Server is starting...&quot;);
                return true;
            &#125; catch (IOException e) &#123;
                // TODO Auto-generated catch block
                return false;
            &#125;
    &#125;
    
    //关闭服务器
    public void closeServer() &#123;
        //判断是否开启服务器
        if(server == null) &#123;
            setLog(&quot;[ERROR]服务器未开启!&quot;);
            return;
        &#125;
        try &#123;
            sendCLOSEtoALL();
            closeAllSocket();
            userList.clear();	//清空用户列表
            server.close();
            server = null;
            setLog(&quot;[INFO]Server is closed.&quot;);
        &#125; catch (Exception e) &#123;
            // TODO Auto-generated catch block
            e.printStackTrace();
        &#125;
    &#125;
    
    //添加当前用户
    public synchronized void addUser(SocketThread User) &#123;
        updateUserList(User);
        userList.add(User);
    &#125;
    
    //获取用户列表
    public void getUsrList(SocketThread sc) &#123;
        if(userList.size()&gt;0) &#123;
            String userlist = &quot;&quot;;
            for(int i = 0 ; i &lt; userList.size() ; i++) &#123;
                userlist += userList.get(i).getName();
                if(i &lt; userList.size() - 1) &#123;
                    userlist += &quot;_&quot;;
                &#125;
            &#125;
            sc.send(&quot;USERLIST|&quot; + userlist);
        &#125;
    &#125;
    
    //为已在线用户添加新登录用户
    public void updateUserList(SocketThread user) &#123;
        for(int i = 0; i &lt; userList.size(); i++) &#123;
            userList.get(i).send(&quot;ADD|&quot;+user.getName());
        &#125;
    &#125;
    
    //发送消息
    public void sendMSG(String[] strs) &#123;
        if(strs[2].equals(&quot;ALL&quot;)) &#123;
            for(SocketThread st:userList) &#123;
                st.send(strs[0]+&quot;|&quot;+strs[1]+&quot;|&quot;+strs[3]);
            &#125;
        &#125;else &#123;
            for(SocketThread st:userList) &#123;
                if(st.getName().equals(strs[2])) &#123;
                    st.send(strs[0]+&quot;|&quot;+strs[1]+&quot;|&quot;+strs[3]);
                &#125;
            &#125;
        &#125;
    &#125;
    
    //删除用户
    public synchronized void deleteUserFromUserlist(String name) &#123;
        for(int i = 0 ; i &lt; userList.size() ; i++) &#123;
            if(userList.get(i).getName().equals(name)) &#123;
                userList.remove(i);
                break;
            &#125;
        &#125;
    &#125;
    
    //通知其他用户，用户下线
    public void deleteUserFromOther(String name) &#123;
        if(!userList.isEmpty()) &#123;
            for(SocketThread st:userList) &#123;
                st.send(&quot;DEL|&quot; + name);
            &#125;
        &#125;
    &#125;
    
    //服务器日志
    public void setLog(String str) &#123;
        serverFrame.textArea.append(str + &quot;\n&quot;);
    &#125;
    
    public void sendCLOSEtoALL() &#123;
        for(int i =0; i &lt; userList.size(); i++) &#123;
            userList.get(i).send(&quot;CLOSE&quot;);
        &#125;
    &#125;
    
    public void closeAllSocket() &#123;
        for(int i =0; i &lt; userList.size(); i++) &#123;
            userList.get(i).closeSocket();
        &#125;
    &#125;
&#125;
</code></pre>
<h4 id="ServerThread-java"><a href="#ServerThread-java" class="headerlink" title="ServerThread.java"></a>ServerThread.java</h4><pre><code class="Java">package Server;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.io.PrintWriter;
import java.net.Socket;
import java.util.ArrayList;
import java.util.HashMap;

public class SocketThread extends Thread&#123;
    Socket socket;
    BufferedReader br = null;
    PrintWriter pw = null;
    public SocketThread(Socket socket)&#123;
        this.socket = socket;
    &#125;
    public void run() &#123;
        try &#123;
            //获取Socket资源
            pw = new PrintWriter(new OutputStreamWriter(socket.getOutputStream(),&quot;utf-8&quot;));
            br = new BufferedReader(new InputStreamReader(socket.getInputStream(),&quot;utf-8&quot;));
            
            //监听客户端
            String Request = &quot;&quot;;
            while((Request = br.readLine()) != null) &#123;
                ServerMG.getServerMG().setLog(&quot;[Client]&quot;+Request);
                String Response = &quot;&quot;;
                
                //判断请求类型
                String[] strs = Request.split(&quot;\\|&quot;);
                
                if(strs[0].equals(&quot;LOGIN&quot;)) &#123;
                    //登录请求
                    this.setName(strs[1]);						//设置名字
                    ServerMG.getServerMG().getUsrList(this);	//发送在线用户列表					
                    ServerMG.getServerMG().addUser(this);		//添加当前用户到用户列表,并且为已在线用户更新用户列表
                &#125;else if(strs[0].equals(&quot;MSG&quot;)) &#123;
                    //发送消息
                    ServerMG.getServerMG().sendMSG(strs);
                &#125;else if(strs[0].equals(&quot;OFFLINE&quot;)) &#123;
                    //用户离线
                    ServerMG.getServerMG().deleteUserFromUserlist(this.getName());
                    ServerMG.getServerMG().deleteUserFromOther(this.getName());
                    break;
                &#125;
            &#125;
        &#125; catch (IOException e) &#123;
            // TODO Auto-generated catch block
            //意外离线
            ServerMG.getServerMG().deleteUserFromUserlist(this.getName());
            ServerMG.getServerMG().deleteUserFromOther(this.getName());
        &#125;finally &#123;
            try &#123;
                if(pw != null) &#123;
                    pw.close();
                &#125;
                if(br != null) &#123;
                    br.close();
                &#125;
                if(socket != null) &#123;
                    socket.close();
                    ServerMG.getServerMG().setLog(&quot;[INFO]&quot;+this.getName()+&quot;已退出&quot;);
                &#125;
            &#125;catch(Exception e) &#123;
                e.printStackTrace();
            &#125;
        &#125;
    &#125;
    
    //发送信息
    public void send(String str) &#123;
        pw.println(str);
        pw.flush();
    &#125;
    
    //关闭会话
    public void closeSocket() &#123;
        try &#123;
            if(pw != null) &#123;
                pw.close();
            &#125;
            if(br != null) &#123;
                br.close();
            &#125;
            if(socket != null) &#123;
                socket.close();
                ServerMG.getServerMG().setLog(&quot;[INFO]&quot;+socket+&quot;已退出&quot;);
            &#125;
        &#125; catch (IOException e) &#123;
            // TODO Auto-generated catch block
            e.printStackTrace();
        &#125;
    &#125;
&#125;
</code></pre>
<h3 id="可拓展功能"><a href="#可拓展功能" class="headerlink" title="可拓展功能"></a>可拓展功能</h3><ul>
<li>结合JDBC，做出登录界面</li>
<li>文件传输功能(时间问题，还没加上)</li>
<li>表情包(原理:客户端本地处理特殊字符)</li>
<li>聊天记录功能</li>
<li>单独聊天窗口</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>第一次运用单例模式实现简单的客户端服务器交互的程序。  </p>
<p><strong>单例模式</strong><br>单例模式（Singleton Pattern）是 Java 中最简单的设计模式之一。这种类型的设计模式属于创建型模式，它提供了一种创建对象的最佳方式。这种模式涉及到一个单一的类，该类负责创建自己的对象，同时确保只有单个对象被创建。这个类提供了一种访问其唯一的对象的方式，可以直接访问，不需要实例化该类的对象。  </p>
<p>在本程序中，服务端和客户端通过单例模式的简单应用，将图形化界面和线程类连接起来，进行功能实现。<br>由于只是用纯Java进行了简单的在线聊天室的实现（无需账户密码登录），故而因此也存在一些问题:  </p>
<ul>
<li>用户名重名</li>
<li>用户在同一客户端重复登录</li>
</ul>
<p>当然，本程序只是作为Socket和多线程入门的综合练手程序，着重点还是用Socket进行应用程序间的通信。故而在本程序中，对于其他细节问题并未做出过多要求。</p>
<p>本程序也存在一些逻辑上不合理的地方和很多还可以优化的地方（为什么不改？我太菜了T.T）  </p>

    </div>
    
    
    
    
    
    
    
</div>

                    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2023 Qheの小窝
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;Qhe
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

                </div>
            </transition>
            
            <transition name="fade">
                <div id="preview" ref="preview" v-show="previewShow">
                    <img id="preview-content" ref="previewContent" />
                </div>
            </transition>
            
        </div>
        <script src="/js/main.js"></script>
        
        




        
    </body>
</html>
